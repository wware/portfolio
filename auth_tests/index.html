
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://wware.github.io/portfolio/auth_tests/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>Test-driven development for the Auth stuff - Science Museum Portfolio</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="lime">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#test-driven-development-for-the-auth-stuff" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Science Museum Portfolio" class="md-header__button md-logo" aria-label="Science Museum Portfolio" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Science Museum Portfolio
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Test-driven development for the Auth stuff
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="lime"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wware/portfolio" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../floor_plan/" class="md-tabs__link">
        
  
    
  
  Floor Plan

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../exhibits/fp-lab/" class="md-tabs__link">
          
  
    
  
  Exhibits

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../papers/" class="md-tabs__link">
        
  
    
  
  Research Papers

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../logs/" class="md-tabs__link">
        
  
    
  
  Visitor Logs

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../example/" class="md-tabs__link">
        
  
    
  
  Items Demo

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Science Museum Portfolio" class="md-nav__button md-logo" aria-label="Science Museum Portfolio" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Science Museum Portfolio
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wware/portfolio" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../floor_plan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Floor Plan
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Exhibits
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Exhibits
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exhibits/fp-lab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functional Programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exhibits/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevOps Observatory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exhibits/embedded/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Embedded Systems
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../papers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Research Papers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visitor Logs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Items Demo
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-testing-https-setup" class="md-nav__link">
    <span class="md-ellipsis">
      1. Testing HTTPS Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-testing-webauthn-user-registrationauthentication" class="md-nav__link">
    <span class="md-ellipsis">
      2. Testing WebAuthn User Registration/Authentication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-testing-jwt-token-creation-and-revocation" class="md-nav__link">
    <span class="md-ellipsis">
      3. Testing JWT Token Creation and Revocation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-sqlite-database" class="md-nav__link">
    <span class="md-ellipsis">
      Setting Up SQLite Database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pytest-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Pytest Configuration
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="test-driven-development-for-the-auth-stuff">Test-driven development for the Auth stuff</h1>
<p>This describes a plan to do TDD on <a href="../auth/">the auth stuff</a>.</p>
<blockquote>
<p>I'm a big fan of test-driven development, and I'd like help in designing a sequence of tests as I incrementally implement some of these ideas. This would be in a development environment using pytest. The first suite of tests would be to make sure HTTPS is set up and working correctly. The second would be to test user registration and the whole passkey workflow, using some kind of mock of the client hardware (ubikey or whatever). The third would be to create a time-limited API token and check that it is handled correctly, and test that the revocation of the token also works correctly. Let's plan on a file-based SQLite database for anything we need to persist. Does all that make sense?</p>
</blockquote>
<p>This sounds like an excellent approach to implementing WebAuthn with a test-driven methodology. Let me outline a testing strategy for each of your three focus areas.</p>
<h2 id="1-testing-https-setup">1. Testing HTTPS Setup</h2>
<p>For testing HTTPS in a development environment:</p>
<details>
    <summary>HTTPS tests</summary>

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

<span class="c1"># Configure base URL for your application</span>
<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://localhost:8443&quot;</span>  <span class="c1"># Adjust port as needed</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">https_session</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a requests session that accepts self-signed certificates for testing&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Warning: Only for development testing!</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>  <span class="c1"># Suppress insecure warnings</span>
    <span class="k">return</span> <span class="n">session</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_https_connection</span><span class="p">(</span><span class="n">https_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test basic HTTPS connection to the server&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">https_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="c1"># Verify we&#39;re using HTTPS</span>
    <span class="k">assert</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_https_redirect</span><span class="p">(</span><span class="n">https_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test HTTP to HTTPS redirect if implemented&quot;&quot;&quot;</span>
    <span class="n">http_url</span> <span class="o">=</span> <span class="n">BASE_URL</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">https_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">http_url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_ssl_certificate</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test SSL certificate information&quot;&quot;&quot;</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">BASE_URL</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
    <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>  <span class="c1"># For self-signed certs in development</span>

    <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">BASE_URL</span><span class="p">)</span><span class="o">.</span><span class="n">port</span> <span class="ow">or</span> <span class="mi">443</span><span class="p">))</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(</span><span class="n">binary_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x509</span> <span class="o">=</span> <span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_ASN1</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span>

        <span class="c1"># Basic certificate checks</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x509</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">get_components</span><span class="p">())</span>
        <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;CN&#39;</span> <span class="ow">in</span> <span class="n">subject</span>  <span class="c1"># Common Name exists</span>
        <span class="c1"># Add more certificate checks as needed</span>
</code></pre></div>
</details>

<h2 id="2-testing-webauthn-user-registrationauthentication">2. Testing WebAuthn User Registration/Authentication</h2>
<p>For WebAuthn testing, we'll use <code>webauthn-mocks</code> library to simulate authenticator hardware:</p>
<details>
    <summary>User Registration/Authentication</summary>

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">webauthn.helpers.structs</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthenticationCredential</span><span class="p">,</span> <span class="n">RegistrationCredential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">your_app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>  <span class="c1"># Import your FastAPI app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>

<span class="c1"># SQLite setup</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up a test SQLite database&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="c1"># Create necessary tables</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    CREATE TABLE users (</span>
<span class="s1">        id TEXT PRIMARY KEY,</span>
<span class="s1">        username TEXT UNIQUE,</span>
<span class="s1">        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s1">    )</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    CREATE TABLE credentials (</span>
<span class="s1">        id TEXT PRIMARY KEY,</span>
<span class="s1">        user_id TEXT,</span>
<span class="s1">        public_key BLOB,</span>
<span class="s1">        sign_count INTEGER,</span>
<span class="s1">        FOREIGN KEY(user_id) REFERENCES users(id)</span>
<span class="s1">    )</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">conn</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test client for the FastAPI app&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1"># Mock WebAuthn registration</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_registration_flow</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the complete WebAuthn registration flow with mocked authenticator&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;test_user&quot;</span>

    <span class="c1"># Step 1: Start registration</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/register/start&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="n">reg_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;challenge&quot;</span> <span class="ow">in</span> <span class="n">reg_data</span>

    <span class="c1"># Step 2: Mock the authenticator response</span>
    <span class="c1"># In real testing, use the webauthn-mocks library to generate realistic credentials</span>
    <span class="n">mock_credential</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_credential_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rawId&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;test_raw_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;public-key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;clientDataJSON&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;webauthn.create&quot;</span><span class="p">,</span>
                <span class="s2">&quot;challenge&quot;</span><span class="p">:</span> <span class="n">reg_data</span><span class="p">[</span><span class="s2">&quot;challenge&quot;</span><span class="p">],</span>
                <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;https://localhost:8443&quot;</span>
            <span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
            <span class="s2">&quot;attestationObject&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;mock_attestation_obj&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># Patch the verify_registration_response function</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;webauthn.verify_registration_response&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_verify</span><span class="p">:</span>
        <span class="c1"># Configure the mock to return a successful verification</span>
        <span class="n">mock_verification</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_verification</span><span class="o">.</span><span class="n">credential_id</span> <span class="o">=</span> <span class="s2">&quot;test_credential_id&quot;</span>
        <span class="n">mock_verification</span><span class="o">.</span><span class="n">credential_public_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;mock_public_key&quot;</span>
        <span class="n">mock_verification</span><span class="o">.</span><span class="n">sign_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mock_verify</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_verification</span>

        <span class="c1"># Step 3: Complete registration</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/register/complete&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s2">&quot;credential&quot;</span><span class="p">:</span> <span class="n">mock_credential</span>
        <span class="p">})</span>

        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>

    <span class="c1"># Verify user was added to database</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE username = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
    <span class="k">assert</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># Verify credential was stored</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM credentials&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Mock WebAuthn authentication</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_authentication_flow</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the WebAuthn authentication flow with mocked authenticator&quot;&quot;&quot;</span>
    <span class="c1"># First, ensure we have a registered user</span>
    <span class="c1"># [Setup code to insert test user and credential in the database]</span>

    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;test_user&quot;</span>

    <span class="c1"># Step 1: Start authentication</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login/start&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="n">auth_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;challenge&quot;</span> <span class="ow">in</span> <span class="n">auth_data</span>

    <span class="c1"># Step 2: Mock the authenticator response</span>
    <span class="n">mock_credential</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_credential_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rawId&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;test_raw_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;public-key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;clientDataJSON&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;webauthn.get&quot;</span><span class="p">,</span>
                <span class="s2">&quot;challenge&quot;</span><span class="p">:</span> <span class="n">auth_data</span><span class="p">[</span><span class="s2">&quot;challenge&quot;</span><span class="p">],</span>
                <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;https://localhost:8443&quot;</span>
            <span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
            <span class="s2">&quot;authenticatorData&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;mock_auth_data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
            <span class="s2">&quot;signature&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;mock_signature&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
            <span class="s2">&quot;userHandle&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;user_handle&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># Patch the verify_authentication_response function</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;webauthn.verify_authentication_response&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_verify</span><span class="p">:</span>
        <span class="c1"># Configure the mock</span>
        <span class="n">mock_verification</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_verification</span><span class="o">.</span><span class="n">new_sign_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mock_verify</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_verification</span>

        <span class="c1"># Step 3: Complete authentication</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login/complete&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s2">&quot;credential&quot;</span><span class="p">:</span> <span class="n">mock_credential</span>
        <span class="p">})</span>

        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;access_token&quot;</span> <span class="ow">in</span> <span class="n">result</span>
</code></pre></div>
</details>

<h2 id="3-testing-jwt-token-creation-and-revocation">3. Testing JWT Token Creation and Revocation</h2>
<details>
    <summary>JWT Token Creation and Revocation</summary>

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_client</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an authenticated client with a valid token&quot;&quot;&quot;</span>
    <span class="c1"># [Setup code to create and authenticate a test user]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login/complete&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;credential&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>  <span class="c1"># Mock credential</span>
    <span class="p">})</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># Create a client with the token in headers</span>
    <span class="n">auth_client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">auth_client</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>

    <span class="c1"># Return both the client and the raw token for tests</span>
    <span class="k">return</span> <span class="n">auth_client</span><span class="p">,</span> <span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_token_creation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test JWT token creation&quot;&quot;&quot;</span>
    <span class="c1"># This can be a unit test for your token creation function</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">your_app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_access_token</span>

    <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;test_user&quot;</span><span class="p">}</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Verify token can be decoded</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">your_app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">TOKEN_ALGORITHM</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">TOKEN_ALGORITHM</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test_user&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;exp&quot;</span> <span class="ow">in</span> <span class="n">decoded</span>
    <span class="c1"># Assert expiration is in the future</span>
    <span class="k">assert</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_protected_endpoint</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test accessing a protected endpoint with a valid token&quot;&quot;&quot;</span>
    <span class="n">client</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">authenticated_client</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/protected-data&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="s2">&quot;secret_value&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_token_expiration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that expired tokens are rejected&quot;&quot;&quot;</span>
    <span class="c1"># Create a token that expires immediately</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">your_app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_access_token</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">TOKEN_ALGORITHM</span>

    <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="s2">&quot;test_user&quot;</span><span class="p">}</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">test_data</span><span class="p">,</span> 
        <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Token expires in 1 second</span>
    <span class="p">)</span>

    <span class="c1"># Wait for token to expire</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Try to use the expired token</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/protected-data&quot;</span><span class="p">)</span>

    <span class="c1"># Should be rejected</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_token_revocation</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test revoking a token&quot;&quot;&quot;</span>
    <span class="n">auth_client</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">authenticated_client</span>

    <span class="c1"># First verify token works</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">auth_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/protected-data&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="c1"># Revoke token</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">auth_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token/revoke&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="c1"># Try to use the revoked token</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">auth_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/protected-data&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>  <span class="c1"># Should be unauthorized</span>
</code></pre></div>
</details>

<h2 id="setting-up-sqlite-database">Setting Up SQLite Database</h2>
<p>For the SQLite integration, you'll need to create a database manager:</p>
<details>
    <summary>Setting Up SQLite Database</summary>

<div class="highlight"><pre><span></span><code><span class="c1"># db.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>

<span class="n">DB_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TEST_DB_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;webauthn_test.db&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">init_db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the database with required tables&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_db</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Create users table</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        CREATE TABLE IF NOT EXISTS users (</span>
<span class="s1">            id TEXT PRIMARY KEY,</span>
<span class="s1">            username TEXT UNIQUE,</span>
<span class="s1">            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s1">        )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Create credentials table</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        CREATE TABLE IF NOT EXISTS credentials (</span>
<span class="s1">            id TEXT PRIMARY KEY,</span>
<span class="s1">            user_id TEXT,</span>
<span class="s1">            public_key BLOB,</span>
<span class="s1">            sign_count INTEGER,</span>
<span class="s1">            FOREIGN KEY(user_id) REFERENCES users(id)</span>
<span class="s1">        )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Create revoked_tokens table</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        CREATE TABLE IF NOT EXISTS revoked_tokens (</span>
<span class="s1">            token TEXT PRIMARY KEY,</span>
<span class="s1">            revoked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s1">        )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager for database connections&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">conn</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
</details>

<h2 id="pytest-configuration">Pytest Configuration</h2>
<p>Create a <code>conftest.py</code> file to set up your test environment:</p>
<details>
    <summary>Pytest Configuration</summary>

<div class="highlight"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">your_app.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_test_db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up a test database for the testing session&quot;&quot;&quot;</span>
    <span class="c1"># Create a temporary file for the test database</span>
    <span class="n">db_fd</span><span class="p">,</span> <span class="n">db_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TEST_DB_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_path</span>

    <span class="c1"># Initialize the database</span>
    <span class="n">init_db</span><span class="p">()</span>

    <span class="k">yield</span>

    <span class="c1"># Clean up</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">db_fd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
</code></pre></div>
</details>

<p>This test plan provides a comprehensive approach to incrementally testing your WebAuthn implementation with FastAPI. The mocking strategy allows you to test WebAuthn functionality without actual hardware authenticators, and the SQLite database provides a simple persistence layer for your tests.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.indexes", "content.tabs.link", "content.code.annotate"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../javascripts/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>