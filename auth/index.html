
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://wware.github.io/portfolio/auth/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>Passkeys and WebAuthn Authentication - Science Museum Portfolio</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="lime">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#passkeys-and-webauthn-authentication" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Science Museum Portfolio" class="md-header__button md-logo" aria-label="Science Museum Portfolio" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Science Museum Portfolio
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Passkeys and WebAuthn Authentication
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="lime"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wware/portfolio" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../floor_plan/" class="md-tabs__link">
        
  
    
  
  Floor Plan

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../exhibits/fp-lab/" class="md-tabs__link">
          
  
    
  
  Exhibits

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../papers/" class="md-tabs__link">
        
  
    
  
  Research Papers

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../logs/" class="md-tabs__link">
        
  
    
  
  Visitor Logs

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../example/" class="md-tabs__link">
        
  
    
  
  Items Demo

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Science Museum Portfolio" class="md-nav__button md-logo" aria-label="Science Museum Portfolio" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Science Museum Portfolio
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wware/portfolio" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../floor_plan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Floor Plan
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Exhibits
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Exhibits
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exhibits/fp-lab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functional Programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exhibits/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevOps Observatory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exhibits/embedded/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Embedded Systems
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../papers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Research Papers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visitor Logs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Items Demo
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#webauthn-explained-simply" class="md-nav__link">
    <span class="md-ellipsis">
      WebAuthn Explained Simply
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WebAuthn Explained Simply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Key Concepts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-a-users-perspective" class="md-nav__link">
    <span class="md-ellipsis">
      From a User's Perspective
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-webauthn-in-fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing WebAuthn in FastAPI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing WebAuthn in FastAPI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-add-webauthn-to-your-fastapi-site" class="md-nav__link">
    <span class="md-ellipsis">
      How to add WebAuthn to your FastAPI site:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-client-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Sample client-side implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-your-project" class="md-nav__link">
    <span class="md-ellipsis">
      Setting Up Your Project
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-keys-more-than-just-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Security Keys: More Than Just Storage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Keys: More Than Just Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-key-security-features" class="md-nav__link">
    <span class="md-ellipsis">
      The Key Security Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-real-secret-sauce" class="md-nav__link">
    <span class="md-ellipsis">
      The Real "Secret Sauce"
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-biometric-authentication-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Non-Biometric Authentication Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-api-tokens-with-webauthn" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing API Tokens with WebAuthn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing API Tokens with WebAuthn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Security Benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Approach
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Approach">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server-side" class="md-nav__link">
    <span class="md-ellipsis">
      Server side
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-side" class="md-nav__link">
    <span class="md-ellipsis">
      Client side
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-components-of-the-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Key Components of the Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Steps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-https-in-fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      Setting Up HTTPS in FastAPI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting Up HTTPS in FastAPI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-1-using-uvicorn-with-ssl-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      Option 1: Using Uvicorn with SSL Certificates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Option 1: Using Uvicorn with SSL Certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ssl-certificates-for-development" class="md-nav__link">
    <span class="md-ellipsis">
      SSL Certificates for Development
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl-certificates-for-production" class="md-nav__link">
    <span class="md-ellipsis">
      SSL Certificates for Production
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SSL Certificates for Production">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lets-encrypt-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Let's Encrypt (Recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commercial-certificate-authorities" class="md-nav__link">
    <span class="md-ellipsis">
      Commercial Certificate Authorities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud-provider-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud Provider Certificates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain-registrar-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      Domain Registrar Certificates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#important-considerations-for-production" class="md-nav__link">
    <span class="md-ellipsis">
      Important Considerations for Production
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-2-using-fastapi-with-https-in-production-code" class="md-nav__link">
    <span class="md-ellipsis">
      Option 2: Using FastAPI with HTTPS in Production Code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-3-production-setup-with-reverse-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      Option 3: Production Setup with Reverse Proxy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-https-in-production-recommended-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Setting Up HTTPS in Production: Recommended Steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-development-with-https" class="md-nav__link">
    <span class="md-ellipsis">
      Local Development with HTTPS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practices-for-https-in-production" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices for HTTPS in Production
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-jwt-in-webauthn" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding JWT in WebAuthn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding JWT in WebAuthn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      What is JWT?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwts-role-in-webauthn" class="md-nav__link">
    <span class="md-ellipsis">
      JWT's Role in WebAuthn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JWT&#39;s Role in WebAuthn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#webauthns-role" class="md-nav__link">
    <span class="md-ellipsis">
      WebAuthn's Role:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwts-role" class="md-nav__link">
    <span class="md-ellipsis">
      JWT's Role:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typical-flow-in-a-webauthn-jwt-system" class="md-nav__link">
    <span class="md-ellipsis">
      Typical Flow in a WebAuthn + JWT System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits-of-combining-webauthn-and-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits of Combining WebAuthn and JWT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maybe-use-google-authenticator-instead" class="md-nav__link">
    <span class="md-ellipsis">
      Maybe use Google Authenticator instead?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Maybe use Google Authenticator instead?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#google-authenticator" class="md-nav__link">
    <span class="md-ellipsis">
      Google Authenticator:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webauthn" class="md-nav__link">
    <span class="md-ellipsis">
      WebAuthn:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-with-google-authenticator" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation with Google Authenticator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation with Google Authenticator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server-side_1" class="md-nav__link">
    <span class="md-ellipsis">
      Server side
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-side_1" class="md-nav__link">
    <span class="md-ellipsis">
      Client side
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-requirements-for-google-authenticator" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Requirements for Google Authenticator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-differences-from-webauthn" class="md-nav__link">
    <span class="md-ellipsis">
      Key Differences from WebAuthn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Differences from WebAuthn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pros-of-google-authenticator" class="md-nav__link">
    <span class="md-ellipsis">
      Pros of Google Authenticator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cons-of-google-authenticator" class="md-nav__link">
    <span class="md-ellipsis">
      Cons of Google Authenticator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#which-to-choose" class="md-nav__link">
    <span class="md-ellipsis">
      Which to Choose?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="passkeys-and-webauthn-authentication">Passkeys and WebAuthn Authentication</h1>
<blockquote>
<p>Assume I have a website built with FastAPI. I want to add WebAuthn authentication but I'm new to that technology. Can you please explain it simply, what it looks like from the user's pov, and how to implement it on the server?</p>
</blockquote>
<h2 id="webauthn-explained-simply">WebAuthn Explained Simply</h2>
<p>WebAuthn (Web Authentication) is a modern, secure way for users to log into websites without passwords. Instead, it uses "authenticators" like:</p>
<ul>
<li>Biometrics (fingerprint/face recognition)</li>
<li>Security keys (like YubiKeys)</li>
<li>Device-based authentication (like Windows Hello)</li>
</ul>
<p>These are either biometric or they depend on a piece of hardware.</p>
<h3 id="key-concepts">Key Concepts</h3>
<ol>
<li>
<p><strong>Registration Flow</strong>:</p>
<ul>
<li>Server creates a challenge and options</li>
<li>Browser prompts user to use authenticator</li>
<li>Server verifies and stores credential</li>
</ul>
</li>
<li>
<p><strong>Login Flow</strong>:</p>
<ul>
<li>Server sends challenge and allowed credentials</li>
<li>Browser prompts for authentication</li>
<li>Server verifies and grants access</li>
</ul>
</li>
<li>
<p><strong>Security Benefits</strong>:</p>
<ul>
<li>No passwords to steal or forget</li>
<li>Resistant to phishing (domain verification)</li>
<li>Protected by hardware/biometrics</li>
</ul>
</li>
<li>
<p><strong>Implementation Notes</strong>:</p>
<ul>
<li>For production, use a proper database</li>
<li>Add HTTPS (required in production)</li>
<li>Consider user experience for different devices</li>
</ul>
</li>
</ol>
<h2 id="from-a-users-perspective">From a User's Perspective</h2>
<p>When a user registers on your site with WebAuthn:</p>
<ol>
<li>They enter a username</li>
<li>Instead of creating a password, they're prompted to use an authenticator (e.g., "Touch your fingerprint sensor")</li>
<li>They complete the verification (touch fingerprint, insert security key, etc.)</li>
<li>Registration complete!</li>
</ol>
<p>When they log in later:</p>
<ol>
<li>They enter their username</li>
<li>They're prompted to use the same authenticator</li>
<li>After verification, they're instantly logged in</li>
</ol>
<p>Users experience this as a quick, password-free login that feels more secure and convenient.</p>
<h2 id="implementing-webauthn-in-fastapi">Implementing WebAuthn in FastAPI</h2>
<h3 id="how-to-add-webauthn-to-your-fastapi-site">How to add WebAuthn to your FastAPI site:</h3>
<details>
    <summary>Server side code in Python</summary>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">WebAuthn Implementation with FastAPI</span>

<span class="sd">This example demonstrates how to implement WebAuthn (Web Authentication) in a FastAPI application.</span>
<span class="sd">It provides endpoints for registration and authentication using WebAuthn.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span><span class="p">,</span> <span class="n">HTMLResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.staticfiles</span><span class="w"> </span><span class="kn">import</span> <span class="n">StaticFiles</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.templating</span><span class="w"> </span><span class="kn">import</span> <span class="n">Jinja2Templates</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">webauthn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">webauthn.helpers.structs</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PublicKeyCredentialCreationOptions</span><span class="p">,</span>
    <span class="n">PublicKeyCredentialRequestOptions</span><span class="p">,</span>
    <span class="n">RegistrationCredential</span><span class="p">,</span>
    <span class="n">AuthenticationCredential</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">webauthn.helpers.cose</span><span class="w"> </span><span class="kn">import</span> <span class="n">COSEAlgorithmIdentifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="c1"># Initialize FastAPI</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;FastAPI WebAuthn Example&quot;</span><span class="p">)</span>

<span class="c1"># This would be your database in a real application</span>
<span class="n">users_db</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">credentials_db</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Store challenges temporarily (in a real app, use Redis or similar)</span>
<span class="n">challenge_db</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Configuration for your application</span>
<span class="n">RELYING_PARTY_ID</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>  <span class="c1"># Your domain name</span>
<span class="n">RELYING_PARTY_NAME</span> <span class="o">=</span> <span class="s2">&quot;FastAPI WebAuthn Example&quot;</span>
<span class="n">RELYING_PARTY_ORIGIN</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># Your origin URL</span>

<span class="c1"># Pydantic models for request validation</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RegisterStartRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RegisterCompleteRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">credential</span><span class="p">:</span> <span class="nb">dict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LoginStartRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LoginCompleteRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">credential</span><span class="p">:</span> <span class="nb">dict</span>

<span class="c1"># Utility functions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_challenge</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a random challenge for WebAuthn operations&quot;&quot;&quot;</span>
    <span class="n">random_bytes</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">random_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

<span class="c1"># API Endpoints</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/register/start&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register_start</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RegisterStartRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the registration process&quot;&quot;&quot;</span>
    <span class="c1"># Check if user already exists</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">username</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User already exists&quot;</span><span class="p">)</span>

    <span class="c1"># Generate a new user ID</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="c1"># Store the user (in a real app, you&#39;d save to a database)</span>
    <span class="n">users_db</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="s2">&quot;credentials&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>

    <span class="c1"># Generate a challenge</span>
    <span class="n">challenge</span> <span class="o">=</span> <span class="n">generate_challenge</span><span class="p">()</span>
    <span class="n">challenge_db</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">challenge</span>

    <span class="c1"># Create WebAuthn registration options</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">PublicKeyCredentialCreationOptions</span><span class="p">(</span>
        <span class="n">rp_id</span><span class="o">=</span><span class="n">RELYING_PARTY_ID</span><span class="p">,</span>
        <span class="n">rp_name</span><span class="o">=</span><span class="n">RELYING_PARTY_NAME</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">user_name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="n">user_display_name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="n">challenge</span><span class="o">=</span><span class="n">challenge</span><span class="p">,</span>
        <span class="n">pubkey_cred_params</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;public-key&quot;</span><span class="p">,</span> <span class="s2">&quot;alg&quot;</span><span class="p">:</span> <span class="n">COSEAlgorithmIdentifier</span><span class="o">.</span><span class="n">ES256</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;public-key&quot;</span><span class="p">,</span> <span class="s2">&quot;alg&quot;</span><span class="p">:</span> <span class="n">COSEAlgorithmIdentifier</span><span class="o">.</span><span class="n">RS256</span><span class="p">},</span>
        <span class="p">],</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span>
        <span class="n">attestation</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span>
        <span class="n">authenticator_selection</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;authenticator_attachment&quot;</span><span class="p">:</span> <span class="s2">&quot;platform&quot;</span><span class="p">,</span>  <span class="c1"># or &quot;cross-platform&quot; for security keys</span>
            <span class="s2">&quot;require_resident_key&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;user_verification&quot;</span><span class="p">:</span> <span class="s2">&quot;preferred&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">exclude_credentials</span><span class="o">=</span><span class="p">[],</span>  <span class="c1"># No credentials to exclude for a new user</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">options</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/register/complete&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register_complete</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RegisterCompleteRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete the registration process&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">username</span>

    <span class="c1"># Check if user exists</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User does not exist&quot;</span><span class="p">)</span>

    <span class="c1"># Get the challenge</span>
    <span class="n">challenge</span> <span class="o">=</span> <span class="n">challenge_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">challenge</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;No challenge found&quot;</span><span class="p">)</span>

    <span class="c1"># Parse the credential</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="n">RegistrationCredential</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">credential</span><span class="p">)</span>

        <span class="c1"># Verify the registration</span>
        <span class="n">registration_verification</span> <span class="o">=</span> <span class="n">webauthn</span><span class="o">.</span><span class="n">verify_registration_response</span><span class="p">(</span>
            <span class="n">credential</span><span class="o">=</span><span class="n">credential</span><span class="p">,</span>
            <span class="n">expected_challenge</span><span class="o">=</span><span class="n">challenge</span><span class="p">,</span>
            <span class="n">expected_origin</span><span class="o">=</span><span class="n">RELYING_PARTY_ORIGIN</span><span class="p">,</span>
            <span class="n">expected_rp_id</span><span class="o">=</span><span class="n">RELYING_PARTY_ID</span><span class="p">,</span>
            <span class="n">require_user_verification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Store the credential</span>
        <span class="n">credential_id</span> <span class="o">=</span> <span class="n">registration_verification</span><span class="o">.</span><span class="n">credential_id</span>
        <span class="n">public_key</span> <span class="o">=</span> <span class="n">registration_verification</span><span class="o">.</span><span class="n">credential_public_key</span>

        <span class="c1"># In a real app, store these in a secure database</span>
        <span class="n">credentials_db</span><span class="p">[</span><span class="n">credential_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s2">&quot;public_key&quot;</span><span class="p">:</span> <span class="n">public_key</span><span class="p">,</span>
            <span class="s2">&quot;sign_count&quot;</span><span class="p">:</span> <span class="n">registration_verification</span><span class="o">.</span><span class="n">sign_count</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Associate credential with user</span>
        <span class="n">users_db</span><span class="p">[</span><span class="n">username</span><span class="p">][</span><span class="s2">&quot;credentials&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">credential_id</span><span class="p">)</span>

        <span class="c1"># Clean up the challenge</span>
        <span class="k">del</span> <span class="n">challenge_db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Registration successful&quot;</span><span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Registration failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login/start&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_start</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">LoginStartRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the login process&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">username</span>

    <span class="c1"># Check if user exists</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User does not exist&quot;</span><span class="p">)</span>

    <span class="c1"># Get user&#39;s credentials</span>
    <span class="n">user_credential_ids</span> <span class="o">=</span> <span class="n">users_db</span><span class="p">[</span><span class="n">username</span><span class="p">][</span><span class="s2">&quot;credentials&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_credential_ids</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;No credentials found for user&quot;</span><span class="p">)</span>

    <span class="c1"># Create a list of allowed credentials</span>
    <span class="n">allowed_credentials</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cred_id</span> <span class="ow">in</span> <span class="n">user_credential_ids</span><span class="p">:</span>
        <span class="n">allowed_credentials</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;public-key&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cred_id</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># Generate a challenge</span>
    <span class="n">challenge</span> <span class="o">=</span> <span class="n">generate_challenge</span><span class="p">()</span>
    <span class="n">challenge_db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">challenge</span>

    <span class="c1"># Create WebAuthn authentication options</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">PublicKeyCredentialRequestOptions</span><span class="p">(</span>
        <span class="n">challenge</span><span class="o">=</span><span class="n">challenge</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span>
        <span class="n">rp_id</span><span class="o">=</span><span class="n">RELYING_PARTY_ID</span><span class="p">,</span>
        <span class="n">allow_credentials</span><span class="o">=</span><span class="n">allowed_credentials</span><span class="p">,</span>
        <span class="n">user_verification</span><span class="o">=</span><span class="s2">&quot;preferred&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">options</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login/complete&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_complete</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">LoginCompleteRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete the login process&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">username</span>

    <span class="c1"># Check if user exists</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User does not exist&quot;</span><span class="p">)</span>

    <span class="c1"># Get the challenge</span>
    <span class="n">challenge</span> <span class="o">=</span> <span class="n">challenge_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">challenge</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;No challenge found&quot;</span><span class="p">)</span>

    <span class="c1"># Parse the credential</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="n">AuthenticationCredential</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">credential</span><span class="p">)</span>

        <span class="c1"># Get credential data</span>
        <span class="n">credential_id</span> <span class="o">=</span> <span class="n">credential</span><span class="o">.</span><span class="n">id</span>
        <span class="n">cred_data</span> <span class="o">=</span> <span class="n">credentials_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">credential_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cred_data</span> <span class="ow">or</span> <span class="n">cred_data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid credential&quot;</span><span class="p">)</span>

        <span class="c1"># Verify the authentication</span>
        <span class="n">auth_verification</span> <span class="o">=</span> <span class="n">webauthn</span><span class="o">.</span><span class="n">verify_authentication_response</span><span class="p">(</span>
            <span class="n">credential</span><span class="o">=</span><span class="n">credential</span><span class="p">,</span>
            <span class="n">expected_challenge</span><span class="o">=</span><span class="n">challenge</span><span class="p">,</span>
            <span class="n">expected_origin</span><span class="o">=</span><span class="n">RELYING_PARTY_ORIGIN</span><span class="p">,</span>
            <span class="n">expected_rp_id</span><span class="o">=</span><span class="n">RELYING_PARTY_ID</span><span class="p">,</span>
            <span class="n">credential_public_key</span><span class="o">=</span><span class="n">cred_data</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">],</span>
            <span class="n">credential_current_sign_count</span><span class="o">=</span><span class="n">cred_data</span><span class="p">[</span><span class="s2">&quot;sign_count&quot;</span><span class="p">],</span>
            <span class="n">require_user_verification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update the sign count</span>
        <span class="n">credentials_db</span><span class="p">[</span><span class="n">credential_id</span><span class="p">][</span><span class="s2">&quot;sign_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_verification</span><span class="o">.</span><span class="n">new_sign_count</span>

        <span class="c1"># Clean up the challenge</span>
        <span class="k">del</span> <span class="n">challenge_db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>

        <span class="c1"># In a real app, you would create a session or JWT token here</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Login successful&quot;</span><span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Authentication failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Serve a simple HTML page for testing</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">Jinja2Templates</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_root</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>

<span class="c1"># Run the application with: uvicorn main:app --reload</span>
</code></pre></div>

</details>

<h3 id="sample-client-side-implementation">Sample client-side implementation</h3>
<details>
    <summary>Client side code in HTML and JavaScript</summary>

<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- </span>
<span class="cm">templates/index.html</span>
<span class="cm">This is a simple client-side implementation of WebAuthn for your FastAPI application.</span>
<span class="cm">Place this file in a &#39;templates&#39; directory in your FastAPI project.</span>
<span class="cm">--&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>WebAuthn Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">        </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">            </span><span class="k">max-width</span><span class="p">:</span><span class="w"> </span><span class="mi">800</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">container</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">            </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">space-between</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">panel</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">flex</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#ccc</span><span class="p">;</span>
<span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">button</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="w"> </span><span class="mi">16</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#4CAF50</span><span class="p">;</span>
<span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
<span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">button</span><span class="p">:</span><span class="nd">hover</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#45a049</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">input</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">box-sizing</span><span class="p">:</span><span class="w"> </span><span class="kc">border-box</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">status</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">success</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#dff0d8</span><span class="p">;</span>
<span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#3c763d</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f2dede</span><span class="p">;</span>
<span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#a94442</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>WebAuthn Example<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Register<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;register-username&quot;</span><span class="p">&gt;</span>Username:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;register-username&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter username&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;register-button&quot;</span><span class="p">&gt;</span>Register<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;register-status&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;status&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;login-username&quot;</span><span class="p">&gt;</span>Username:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-username&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter username&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-button&quot;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-status&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;status&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">        </span><span class="c1">// Helper functions for encoding/decoding base64url</span>
<span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">base64Url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;=&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">((</span><span class="mf">4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="nx">base64Url</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span><span class="p">))</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64Url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;+&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">padding</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">binary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">atob</span><span class="p">(</span><span class="nx">base64</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">ArrayBuffer</span><span class="p">(</span><span class="nx">binary</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">buffer</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="kr">byte</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">str</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="kr">byte</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">btoa</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">base64</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\+/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\//g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/=/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ------ Registration Functions ------</span>
<span class="w">        </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">startRegistration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;register-username&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;register-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Please enter a username&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Call the registration start endpoint</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/register/start&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="p">}),</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Registration start failed: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Get the options from the server</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// Convert base64url strings to ArrayBuffers</span>
<span class="w">                </span><span class="nx">options</span><span class="p">.</span><span class="nx">challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">challenge</span><span class="p">);</span>
<span class="w">                </span><span class="nx">options</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">excludeCredentials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">cred</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">excludeCredentials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">cred</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">cred</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Create credentials</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">publicKey</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Complete the registration</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">completeRegistration</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">credential</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;register-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`Error: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Registration error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">completeRegistration</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">credential</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Convert the credential to JSON</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">credentialJSON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">                </span><span class="nx">rawId</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">rawId</span><span class="p">),</span>
<span class="w">                </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
<span class="w">                </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">clientDataJSON</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">clientDataJSON</span><span class="p">),</span>
<span class="w">                    </span><span class="nx">attestationObject</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">attestationObject</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="c1">// Call the registration complete endpoint</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/register/complete&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">username</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">credential</span><span class="o">:</span><span class="w"> </span><span class="nx">credentialJSON</span>
<span class="w">                </span><span class="p">}),</span>
<span class="w">            </span><span class="p">});</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Registration failed: </span><span class="si">${</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">detail</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">            </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;register-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Registration successful!&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ------ Login Functions ------</span>
<span class="w">        </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">startLogin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;login-username&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Please enter a username&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Call the login start endpoint</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/login/start&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="p">}),</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Login start failed: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Get the options from the server</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// Convert base64url strings to ArrayBuffers</span>
<span class="w">                </span><span class="nx">options</span><span class="p">.</span><span class="nx">challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">challenge</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">allowCredentials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">cred</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">allowCredentials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">cred</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">cred</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Get credentials</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">publicKey</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Complete the login</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">completeLogin</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">credential</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`Error: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Login error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">completeLogin</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">credential</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Convert the credential to JSON</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">credentialJSON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">                </span><span class="nx">rawId</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">rawId</span><span class="p">),</span>
<span class="w">                </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
<span class="w">                </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">clientDataJSON</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">clientDataJSON</span><span class="p">),</span>
<span class="w">                    </span><span class="nx">authenticatorData</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">authenticatorData</span><span class="p">),</span>
<span class="w">                    </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">signature</span><span class="p">),</span>
<span class="w">                    </span><span class="nx">userHandle</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">userHandle</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">userHandle</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="c1">// Call the login complete endpoint</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/login/complete&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">username</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">credential</span><span class="o">:</span><span class="w"> </span><span class="nx">credentialJSON</span>
<span class="w">                </span><span class="p">}),</span>
<span class="w">            </span><span class="p">});</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Login failed: </span><span class="si">${</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">detail</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">            </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Login successful!&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Helper function to update status messages</span>
<span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateStatus</span><span class="p">(</span><span class="nx">elementId</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">statusElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">elementId</span><span class="p">);</span>
<span class="w">            </span><span class="nx">statusElement</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">;</span>
<span class="w">            </span><span class="nx">statusElement</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;status &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">type</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Add event listeners</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;register-button&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">startRegistration</span><span class="p">);</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;login-button&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">startLogin</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

</details>

<h2 id="setting-up-your-project">Setting Up Your Project</h2>
<ol>
<li>First, install required packages:</li>
</ol>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span>uvicorn<span class="w"> </span>webauthn-python<span class="w"> </span>pydantic<span class="w"> </span>jinja2
</code></pre></div>
<ol>
<li>Create the project structure:</li>
</ol>
<div class="highlight"><pre><span></span><code>your_project/
 main.py            # FastAPI backend code
 templates/
     index.html     # Frontend HTML/JS
</code></pre></div>
<ol>
<li>
<p>Copy the backend code to <code>main.py</code> and the frontend code to <code>templates/index.html</code>.</p>
</li>
<li>
<p>Run the application:</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>uvicorn<span class="w"> </span>main:app<span class="w"> </span>--reload
</code></pre></div>
<ol>
<li>Visit <code>http://localhost:8000</code> in your browser to test.</li>
</ol>
<h2 id="security-keys-more-than-just-storage">Security Keys: More Than Just Storage</h2>
<blockquote>
<p>For a webauthn client that is not using biometrics, is there some hardware secret sauce required? or is it just the designated locus for the private key?</p>
</blockquote>
<p>Your question gets right to the heart of what makes WebAuthn security keys special. It's not just about storing the private key - there's indeed some "hardware secret sauce" involved.</p>
<h3 id="the-key-security-features">The Key Security Features</h3>
<p>Security keys (like YubiKeys, Google Titan keys, etc.) have several crucial security properties:</p>
<ul>
<li>
<p><strong>Secure Element</strong>: They contain a tamper-resistant secure element (specialized microchip) that:</p>
<ul>
<li>Generates and stores cryptographic keys</li>
<li>Performs cryptographic operations inside the chip</li>
<li>Prevents the private key from ever being exported or extracted</li>
</ul>
</li>
<li>
<p><strong>User Presence Verification</strong>: The physical button/touch sensor isn't just for show:</p>
<ul>
<li>Ensures a human is present during each authentication</li>
<li>Prevents remote malware from silently using the key</li>
<li>Creates a physical action requirement for each authentication</li>
</ul>
</li>
<li>
<p><strong>Counter Mechanism</strong>: Keys maintain an internal counter that:</p>
<ul>
<li>Increments with each use</li>
<li>Helps detect cloned authenticators</li>
<li>Allows servers to identify replay attacks</li>
</ul>
</li>
<li>
<p><strong>Origin Binding</strong>: The key cryptographically ties authentication to specific websites:</p>
<ul>
<li>Prevents phishing by binding credentials to the correct domain</li>
<li>Stops credentials generated for one site from being used on another</li>
</ul>
</li>
</ul>
<h3 id="the-real-secret-sauce">The Real "Secret Sauce"</h3>
<p>The most important aspect is that the private key <strong>cannot be extracted</strong> - even by the device owner. All cryptographic operations happen inside the secure element. This means:</p>
<ol>
<li>The private key never leaves the device</li>
<li>The key cannot be copied, backed up, or cloned</li>
<li>Malware on your computer cannot access the key</li>
<li>Even sophisticated hardware attacks are extremely difficult</li>
</ol>
<p>This hardware-enforced key isolation is what differentiates a WebAuthn security key from software-based approaches where private keys might be vulnerable to extraction.</p>
<h3 id="non-biometric-authentication-flow">Non-Biometric Authentication Flow</h3>
<p>Without biometrics, the authentication flow is:</p>
<ol>
<li>Website challenges the security key</li>
<li>User proves physical presence by touching the key</li>
<li>Key performs the cryptographic operation internally</li>
<li>Key returns only the signed challenge (never the private key)</li>
</ol>
<p>So yes - the security key is far more than just a designated place to store a private key. It's a specialized cryptographic device with hardware-based security controls that create a trusted, phishing-resistant authentication mechanism.</p>
<h2 id="implementing-api-tokens-with-webauthn">Implementing API Tokens with WebAuthn</h2>
<blockquote>
<p>Once a user has registered, I would like the server to be able to issue a time-limited API token which could be used by client side scripts that want to make API calls. Is that good security practice? How would that be implemented on the server side?</p>
</blockquote>
<p>Yes, issuing time-limited API tokens after WebAuthn authentication is a good security practice. This approach follows the principle of "authenticate heavily once, then use lighter verification for a limited time" - similar to how modern authentication systems work.</p>
<h3 id="security-benefits">Security Benefits</h3>
<ul>
<li><strong>Separation of concerns</strong>: Strong authentication (WebAuthn) is separate from API authorization (tokens)</li>
<li><strong>Limited exposure</strong>: Short-lived tokens reduce the risk if intercepted</li>
<li><strong>Revocable access</strong>: You can invalidate tokens if needed without requiring re-authentication</li>
<li><strong>Reduced authentication burden</strong>: Users don't need to repeatedly use their authenticator</li>
</ul>
<h3 id="implementation-approach">Implementation Approach</h3>
<h4 id="server-side">Server side</h4>
<details>
    <summary>Python code</summary>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">API Token Implementation with FastAPI and WebAuthn</span>

<span class="sd">This code extends the WebAuthn implementation to include API token generation,</span>
<span class="sd">validation, and usage for authenticated users.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBearer</span><span class="p">,</span> <span class="n">HTTPAuthorizationCredentials</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1"># Include all the imports and WebAuthn code from the previous example</span>
<span class="c1"># ...</span>

<span class="c1"># Token configuration</span>
<span class="n">JWT_SECRET</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># Generate a secure random key for JWT signing</span>
<span class="n">TOKEN_ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
<span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Short-lived tokens for security</span>

<span class="c1"># Token database (in a real app, use Redis or similar)</span>
<span class="n">token_blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="c1"># Token models</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">datetime</span>

<span class="c1"># OAuth2 scheme for token authentication</span>
<span class="n">security</span> <span class="o">=</span> <span class="n">HTTPBearer</span><span class="p">()</span>

<span class="c1"># Utility functions for tokens</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new JWT token with expiration time&quot;&quot;&quot;</span>
    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">expires_delta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>

    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">TOKEN_ALGORITHM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">encoded_jwt</span><span class="p">,</span> <span class="n">expire</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify a JWT token and return the payload&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if token is blacklisted</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">token_blacklist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> 
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Token has been revoked&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Decode and verify the token</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">TOKEN_ALGORITHM</span><span class="p">])</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> 
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid token payload&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check if user exists</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> 
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User does not exist&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">PyJWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> 
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid token or token expired&quot;</span>
        <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span><span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dependency to get the current user from a token&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">users_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="c1"># Modified login endpoint to include token generation</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login/complete&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_complete</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">LoginCompleteRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete the login process and return an access token&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">username</span>

    <span class="c1"># Check if user exists</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User does not exist&quot;</span><span class="p">)</span>

    <span class="c1"># Get the challenge</span>
    <span class="n">challenge</span> <span class="o">=</span> <span class="n">challenge_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">challenge</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;No challenge found&quot;</span><span class="p">)</span>

    <span class="c1"># Parse the credential</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">credential</span> <span class="o">=</span> <span class="n">AuthenticationCredential</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">credential</span><span class="p">)</span>

        <span class="c1"># Get credential data</span>
        <span class="n">credential_id</span> <span class="o">=</span> <span class="n">credential</span><span class="o">.</span><span class="n">id</span>
        <span class="n">cred_data</span> <span class="o">=</span> <span class="n">credentials_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">credential_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cred_data</span> <span class="ow">or</span> <span class="n">cred_data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid credential&quot;</span><span class="p">)</span>

        <span class="c1"># Verify the authentication</span>
        <span class="n">auth_verification</span> <span class="o">=</span> <span class="n">webauthn</span><span class="o">.</span><span class="n">verify_authentication_response</span><span class="p">(</span>
            <span class="n">credential</span><span class="o">=</span><span class="n">credential</span><span class="p">,</span>
            <span class="n">expected_challenge</span><span class="o">=</span><span class="n">challenge</span><span class="p">,</span>
            <span class="n">expected_origin</span><span class="o">=</span><span class="n">RELYING_PARTY_ORIGIN</span><span class="p">,</span>
            <span class="n">expected_rp_id</span><span class="o">=</span><span class="n">RELYING_PARTY_ID</span><span class="p">,</span>
            <span class="n">credential_public_key</span><span class="o">=</span><span class="n">cred_data</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">],</span>
            <span class="n">credential_current_sign_count</span><span class="o">=</span><span class="n">cred_data</span><span class="p">[</span><span class="s2">&quot;sign_count&quot;</span><span class="p">],</span>
            <span class="n">require_user_verification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update the sign count</span>
        <span class="n">credentials_db</span><span class="p">[</span><span class="n">credential_id</span><span class="p">][</span><span class="s2">&quot;sign_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_verification</span><span class="o">.</span><span class="n">new_sign_count</span>

        <span class="c1"># Clean up the challenge</span>
        <span class="k">del</span> <span class="n">challenge_db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>

        <span class="c1"># Generate access token</span>
        <span class="n">access_token</span><span class="p">,</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">},</span>
            <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Login successful&quot;</span><span class="p">,</span>
            <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
            <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expire</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Authentication failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># New token endpoints</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token/refresh&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_token</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a new token with a fresh expiration time&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>

    <span class="c1"># Generate a new access token</span>
    <span class="n">access_token</span><span class="p">,</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">},</span>
        <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expire</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token/revoke&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">revoke_token</span><span class="p">(</span><span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Revoke a token by adding it to the blacklist&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>

    <span class="c1"># Verify the token is valid before revoking</span>
    <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="c1"># Add to blacklist</span>
    <span class="n">token_blacklist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Token revoked successfully&quot;</span><span class="p">}</span>

<span class="c1"># Protected API route example</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/protected-data&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_protected_data</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example protected API endpoint requiring a valid token&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, this is protected data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;secret_value&quot;</span><span class="p">:</span> <span class="s2">&quot;This data is only accessible with a valid token&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1"># Sample API for listing user credentials (admin only in a real app)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/user/credentials&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_credentials</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all credentials registered for the current user&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>

    <span class="c1"># Get credential IDs</span>
    <span class="n">credential_ids</span> <span class="o">=</span> <span class="n">users_db</span><span class="p">[</span><span class="n">username</span><span class="p">][</span><span class="s2">&quot;credentials&quot;</span><span class="p">]</span>

    <span class="c1"># Get credential details</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cred_id</span> <span class="ow">in</span> <span class="n">credential_ids</span><span class="p">:</span>
        <span class="n">cred_data</span> <span class="o">=</span> <span class="n">credentials_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cred_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cred_data</span><span class="p">:</span>
            <span class="n">credentials</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cred_id</span><span class="p">,</span>
                <span class="s2">&quot;sign_count&quot;</span><span class="p">:</span> <span class="n">cred_data</span><span class="p">[</span><span class="s2">&quot;sign_count&quot;</span><span class="p">],</span>
                <span class="c1"># Don&#39;t include the public key in the response for security</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="s2">&quot;credential_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">credentials</span><span class="p">),</span>
        <span class="s2">&quot;credentials&quot;</span><span class="p">:</span> <span class="n">credentials</span>
    <span class="p">}</span>
</code></pre></div>
</details>

<h4 id="client-side">Client side</h4>
<details>
    <summary>JavaScript code</summary>

<div class="highlight"><pre><span></span><code><span class="c1">// Client-side JavaScript for handling API tokens</span>
<span class="c1">// Add this to your index.html file</span>

<span class="c1">// Token storage</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="c1">// Utility function to safely store tokens</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">storeToken</span><span class="p">(</span><span class="nx">tokenData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Store the token in memory (for this session)</span>
<span class="w">    </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">access_token</span><span class="p">;</span>
<span class="w">    </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">expires_at</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Optional: Store in localStorage for persistent sessions</span>
<span class="w">    </span><span class="c1">// Note: LocalStorage is vulnerable to XSS, so use with caution</span>
<span class="w">    </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">access_token</span><span class="p">);</span>
<span class="w">    </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;tokenExpiry&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">expires_at</span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Token stored. Expires at </span><span class="si">${</span><span class="nx">tokenExpiry</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Check if token exists and is valid</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">hasValidToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// If we don&#39;t have a token in memory, check localStorage</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">authToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;tokenExpiry&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check if we have a token and it&#39;s not expired</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Add a 30-second buffer to ensure token isn&#39;t about to expire</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 30 seconds in milliseconds</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">now</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">bufferTime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Clear token on logout</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">clearToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;tokenExpiry&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Function to handle login and token acquisition</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">loginWithWebAuthn</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Start the WebAuthn login process</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">startResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/login/start&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="p">}),</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">startResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Login start failed: </span><span class="si">${</span><span class="nx">startResponse</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">startResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Convert base64url strings to ArrayBuffers</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">challenge</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">allowCredentials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">cred</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">allowCredentials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">cred</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlToBuffer</span><span class="p">(</span><span class="nx">cred</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Request the credential from the authenticator</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span>
<span class="w">            </span><span class="nx">publicKey</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Convert credential for sending to server</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">credentialJSON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">            </span><span class="nx">rawId</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">rawId</span><span class="p">),</span>
<span class="w">            </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
<span class="w">            </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">clientDataJSON</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">clientDataJSON</span><span class="p">),</span>
<span class="w">                </span><span class="nx">authenticatorData</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">authenticatorData</span><span class="p">),</span>
<span class="w">                </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">signature</span><span class="p">),</span>
<span class="w">                </span><span class="nx">userHandle</span><span class="o">:</span><span class="w"> </span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">userHandle</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">bufferToBase64Url</span><span class="p">(</span><span class="nx">credential</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">userHandle</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Complete the login and get token</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">completeResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/login/complete&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                </span><span class="nx">username</span><span class="p">,</span>
<span class="w">                </span><span class="nx">credential</span><span class="o">:</span><span class="w"> </span><span class="nx">credentialJSON</span>
<span class="w">            </span><span class="p">}),</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">completeResponse</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">completeResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Login failed: </span><span class="si">${</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">detail</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">completeResponse</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Get the token and store it</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">completeResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">        </span><span class="nx">storeToken</span><span class="p">(</span><span class="nx">tokenData</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Login successful&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">tokenData</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Login error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Function to make authenticated API requests</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchWithAuth</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Check if token is valid</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasValidToken</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// No valid token, user needs to login again</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;No valid authentication token. Please login again.&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Add Authorization header to request</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">authOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">options</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">...</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">authToken</span><span class="si">}</span><span class="sb">`</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Make the authenticated request</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">authOptions</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Handle 401 Unauthorized (token expired or invalid)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">401</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">clearToken</span><span class="p">();</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Authentication token expired or invalid. Please login again.&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Sample function to refresh the token</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">refreshToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchWithAuth</span><span class="p">(</span><span class="s1">&#39;/token/refresh&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to refresh token&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">        </span><span class="nx">storeToken</span><span class="p">(</span><span class="nx">tokenData</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Token refreshed successfully&#39;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Token refresh error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sample function to logout and revoke token</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">logout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasValidToken</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Revoke the token on the server</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchWithAuth</span><span class="p">(</span><span class="s1">&#39;/token/revoke&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error revoking token:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Clear token from storage regardless of server response</span>
<span class="w">    </span><span class="nx">clearToken</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Logged out successfully&#39;</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Sample function to access a protected API endpoint</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchProtectedData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchWithAuth</span><span class="p">(</span><span class="s1">&#39;/api/protected-data&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`API request failed: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;API request error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Add event listeners for demo buttons</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Adding logout functionality</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logoutButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">logoutButton</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;logout-button&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">logoutButton</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Logout&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">logoutButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">logout</span><span class="p">();</span>
<span class="w">        </span><span class="nx">alert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Update UI to reflect logged out state</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;token-info&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Not logged in&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;protected-data&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Button to fetch protected data</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dataButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">dataButton</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fetch-data-button&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">dataButton</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Fetch Protected Data&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">dataButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchProtectedData</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;protected-data&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                    </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Add new elements to page</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.container&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create API test panel</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiPanel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">apiPanel</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;panel&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">apiPanel</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">        &lt;h2&gt;API Access&lt;/h2&gt;</span>
<span class="sb">        &lt;div&gt;</span>
<span class="sb">            &lt;p&gt;Token Status: &lt;span id=&quot;token-info&quot;&gt;Not logged in&lt;/span&gt;&lt;/p&gt;</span>
<span class="sb">            &lt;div id=&quot;api-buttons&quot;&gt;&lt;/div&gt;</span>
<span class="sb">            &lt;h3&gt;Protected Data:&lt;/h3&gt;</span>
<span class="sb">            &lt;pre id=&quot;protected-data&quot;&gt;&lt;/pre&gt;</span>
<span class="sb">        &lt;/div&gt;</span>
<span class="sb">    `</span><span class="p">;</span>

<span class="w">    </span><span class="nx">container</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">apiPanel</span><span class="p">);</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;api-buttons&#39;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">dataButton</span><span class="p">);</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;api-buttons&#39;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">logoutButton</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Update login success handler to also update token info</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalLoginButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;login-button&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">originalLoginButton</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">startLogin</span><span class="p">);</span>
<span class="w">    </span><span class="nx">originalLoginButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;login-username&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Please enter a username&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loginWithWebAuthn</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Login successful!&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;token-info&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                </span><span class="sb">`Logged in as </span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">. Token expires at </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">expires_at</span><span class="p">).</span><span class="nx">toLocaleTimeString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`Error: </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check for existing token on page load</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasValidToken</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;token-info&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">            </span><span class="sb">`Token valid until </span><span class="si">${</span><span class="nx">tokenExpiry</span><span class="p">.</span><span class="nx">toLocaleTimeString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</details>

<h3 id="key-components-of-the-implementation">Key Components of the Implementation</h3>
<ul>
<li>
<p><strong>Token Generation</strong>:</p>
<ul>
<li>After successful WebAuthn authentication, the server generates a JWT (JSON Web Token)</li>
<li>The token contains the username and expiration time</li>
<li>Tokens are signed with a secret key to prevent tampering</li>
</ul>
</li>
<li>
<p><strong>Token Management</strong>:</p>
<ul>
<li><strong>Storage</strong>: Client stores tokens in memory and optionally in localStorage</li>
<li><strong>Validation</strong>: Server verifies token signature and expiration</li>
<li><strong>Refresh</strong>: Client can request a new token before expiration</li>
<li><strong>Revocation</strong>: Server maintains a blacklist of revoked tokens</li>
</ul>
</li>
<li>
<p><strong>API Security Flow</strong>:</p>
<ul>
<li>User authenticates with WebAuthn</li>
<li>Server issues a short-lived token (30 minutes in the example)</li>
<li>Client includes token in Authorization header for API requests</li>
<li>Server validates token before processing the request</li>
</ul>
</li>
</ul>
<h3 id="security-considerations">Security Considerations</h3>
<ul>
<li>
<p><strong>Token Lifetime</strong>:</p>
<ul>
<li>Shorter lifetimes (15-60 minutes) are more secure</li>
<li>Balance security with user experience</li>
</ul>
</li>
<li>
<p><strong>Token Storage</strong>:</p>
<ul>
<li>Memory storage (variables) is cleared when page refreshes</li>
<li>localStorage persists but is vulnerable to XSS attacks</li>
<li>Consider using HttpOnly cookies as an alternative</li>
</ul>
</li>
<li>
<p><strong>Token Revocation</strong>:</p>
<ul>
<li>Implement server-side blacklisting for immediate revocation</li>
<li>For large-scale applications, use Redis or similar for blacklist storage</li>
</ul>
</li>
<li>
<p><strong>JWT Claims</strong>:</p>
<ul>
<li>Include minimal necessary data (username/user ID)</li>
<li>Add additional claims like IP address or device fingerprint for extra security</li>
</ul>
</li>
</ul>
<h3 id="implementation-steps">Implementation Steps</h3>
<ol>
<li>
<p>Add the JWT package to your project:
   <div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>python-jose<span class="o">[</span>cryptography<span class="o">]</span>
</code></pre></div></p>
</li>
<li>
<p>Add the token generation to the login endpoint</p>
</li>
<li>
<p>Add middleware or dependencies to validate tokens</p>
</li>
<li>
<p>Create endpoints for token refresh and revocation</p>
</li>
<li>
<p>Update your client-side code to manage tokens</p>
</li>
</ol>
<p>This approach gives you a robust authentication system combining the security benefits of WebAuthn for initial authentication with the convenience of API tokens for continued access.</p>
<h2 id="setting-up-https-in-fastapi">Setting Up HTTPS in FastAPI</h2>
<p>Running FastAPI with HTTPS is essential for security, especially when implementing authentication like WebAuthn (which requires HTTPS except on localhost). Here's why:</p>
<ol>
<li><strong>Data encryption</strong> between client and server</li>
<li><strong>Authentication</strong> of the server to clients</li>
<li><strong>Required for WebAuthn</strong> in production environments</li>
<li><strong>Protection against</strong> man-in-the-middle attacks</li>
</ol>
<h3 id="option-1-using-uvicorn-with-ssl-certificates">Option 1: Using Uvicorn with SSL Certificates</h3>
<p>The simplest approach is running Uvicorn (the ASGI server for FastAPI) with SSL certificates:</p>
<div class="highlight"><pre><span></span><code>uvicorn<span class="w"> </span>main:app<span class="w"> </span>--ssl-keyfile<span class="o">=</span>./key.pem<span class="w"> </span>--ssl-certfile<span class="o">=</span>./cert.pem
</code></pre></div>
<p>You'll need:</p>
<ul>
<li><strong>key.pem</strong>: The private key file</li>
<li><strong>cert.pem</strong>: The SSL certificate file</li>
</ul>
<h4 id="ssl-certificates-for-development">SSL Certificates for Development</h4>
<p><font color="red">THIS IS FOR DEVELOPMENT ONLY!</font> See notes about production below.</p>
<p>For development, you can create self-signed certificates using OpenSSL.
When running the OpenSSL commands, you'll be prompted for certificate information:</p>
<ul>
<li>Country Name (2 letter code)</li>
<li>State or Province</li>
<li>Locality Name (city)</li>
<li>Organization Name</li>
<li>Organizational Unit</li>
<li>Common Name (IMPORTANT: use your domain name or localhost)</li>
<li>Email Address</li>
</ul>
<details>
    <summary>How to create self-signed certificates</summary>

<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Generate a private key</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>key.pem<span class="w"> </span><span class="m">2048</span>

<span class="c1"># Generate a certificate signing request (CSR)</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>key.pem<span class="w"> </span>-out<span class="w"> </span>csr.pem

<span class="c1"># Generate a self-signed certificate (valid for 365 days)</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-in<span class="w"> </span>csr.pem<span class="w"> </span>-signkey<span class="w"> </span>key.pem<span class="w"> </span>-out<span class="w"> </span>cert.pem

<span class="c1"># Clean up the CSR file</span>
rm<span class="w"> </span>csr.pem

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Self-signed certificate generated:&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Private key: key.pem&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Certificate: cert.pem&quot;</span>
</code></pre></div>
</details>

<h4 id="ssl-certificates-for-production">SSL Certificates for Production</h4>
<p>For a production environment, you'll want to obtain trusted SSL certificates that browsers will recognize without security warnings. Here are the best options:</p>
<h5 id="lets-encrypt-recommended">Let's Encrypt (Recommended)</h5>
<p>Let's Encrypt is a free, automated, and open certificate authority that provides trusted SSL certificates.</p>
<ul>
<li>Completely free</li>
<li>Automated renewal process</li>
<li>Trusted by all major browsers</li>
<li>Easy to set up</li>
</ul>
<p>How to get Let's Encrypt certificates:</p>
<ol>
<li>
<p><strong>Install Certbot</strong>:
   <div class="highlight"><pre><span></span><code><span class="c1"># On Ubuntu/Debian</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>certbot

<span class="c1"># For Nginx</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>python3-certbot-nginx

<span class="c1"># For Apache</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>python3-certbot-apache
</code></pre></div></p>
</li>
<li>
<p><strong>Generate certificates</strong>:
   <div class="highlight"><pre><span></span><code><span class="c1"># With Nginx</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>--nginx<span class="w"> </span>-d<span class="w"> </span>yourdomain.com<span class="w"> </span>-d<span class="w"> </span>www.yourdomain.com

<span class="c1"># With Apache</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>--apache<span class="w"> </span>-d<span class="w"> </span>yourdomain.com<span class="w"> </span>-d<span class="w"> </span>www.yourdomain.com

<span class="c1"># Standalone (if no web server is running)</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--standalone<span class="w"> </span>-d<span class="w"> </span>yourdomain.com<span class="w"> </span>-d<span class="w"> </span>www.yourdomain.com
</code></pre></div></p>
</li>
<li>
<p><strong>Set up auto-renewal</strong>:
   <div class="highlight"><pre><span></span><code><span class="c1"># Test auto-renewal</span>
sudo<span class="w"> </span>certbot<span class="w"> </span>renew<span class="w"> </span>--dry-run

<span class="c1"># Certbot installs a cron job or systemd timer automatically</span>
</code></pre></div></p>
</li>
</ol>
<h5 id="commercial-certificate-authorities">Commercial Certificate Authorities</h5>
<p>If you prefer a paid option (often with extended validation or additional features):</p>
<ol>
<li><strong>DigiCert</strong>: Premium certificates with high browser trust</li>
<li><strong>Sectigo</strong> (formerly Comodo): Cost-effective with multi-domain options</li>
<li><strong>GlobalSign</strong>: Good for enterprise with managed services</li>
<li><strong>GoDaddy</strong>: Popular with good integration if you already use their services</li>
</ol>
<p>These typically cost $50-300 per year depending on the validation level and features.</p>
<h5 id="cloud-provider-certificates">Cloud Provider Certificates</h5>
<p>If your application is hosted with a cloud provider:</p>
<ol>
<li><strong>AWS Certificate Manager</strong>: Free SSL certificates for AWS services</li>
<li><strong>Google Cloud Certificate Manager</strong>: Free SSL certificates with Google Cloud</li>
<li><strong>Azure App Service</strong>: Free certificates for Azure-hosted services</li>
</ol>
<h5 id="domain-registrar-certificates">Domain Registrar Certificates</h5>
<p>Many domain registrars now offer free or inexpensive SSL certificates:</p>
<ol>
<li><strong>Cloudflare</strong>: Free SSL with their CDN service</li>
<li><strong>Namecheap</strong>: Affordable certificates bundled with domain registration</li>
</ol>
<h4 id="important-considerations-for-production">Important Considerations for Production</h4>
<ol>
<li><strong>Validity period</strong>: Let's Encrypt certificates last 90 days and must be renewed</li>
<li><strong>Automation</strong>: Set up automatic renewal to avoid expiration</li>
<li><strong>Certificate chain</strong>: Ensure the full chain is included</li>
<li><strong>Key security</strong>: Keep your private keys secure</li>
<li><strong>Monitoring</strong>: Set up monitoring for certificate expiration</li>
</ol>
<p>For most applications, Let's Encrypt is the ideal solution due to its ease of use, zero cost, and automated renewal process. The certificates are trusted by all major browsers and provide the same level of encryption as paid certificates.</p>
<h3 id="option-2-using-fastapi-with-https-in-production-code">Option 2: Using FastAPI with HTTPS in Production Code</h3>
<p>For more production-ready code, you can configure HTTPS directly in your application:</p>
<details>
    <summary>FastAPI HTTPS configuration</summary>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">HTTPS Configuration for FastAPI</span>

<span class="sd">This script demonstrates how to run FastAPI with HTTPS enabled</span>
<span class="sd">using Uvicorn programmatically.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

<span class="c1"># Create the FastAPI app</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello, HTTPS World!&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/secure&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">secure_endpoint</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;This endpoint is secure!&quot;</span><span class="p">}</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Set up command line arguments</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run FastAPI with HTTPS&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--host&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Host to bind to&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8443</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Port to bind to&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ssl-keyfile&quot;</span><span class="p">,</span> 
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./key.pem&quot;</span><span class="p">,</span> 
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SSL key file path&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ssl-certfile&quot;</span><span class="p">,</span> 
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./cert.pem&quot;</span><span class="p">,</span> 
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SSL certificate file path&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--reload&quot;</span><span class="p">,</span> 
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> 
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable auto-reload for development&quot;</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Verify SSL files exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_keyfile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SSL key file not found: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_keyfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_certfile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SSL certificate file not found: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_certfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Configure and run Uvicorn with SSL</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="s2">&quot;main:app&quot;</span><span class="p">,</span>  <span class="c1"># Replace with the actual path to your app</span>
        <span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
        <span class="n">ssl_keyfile</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_keyfile</span><span class="p">,</span>
        <span class="n">ssl_certfile</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_certfile</span><span class="p">,</span>
        <span class="n">reload</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">reload</span>
    <span class="p">)</span>

    <span class="c1"># Run with:</span>
    <span class="c1"># python main.py --port=8443 --ssl-keyfile=./key.pem --ssl-certfile=./cert.pem</span>
</code></pre></div>
</details>

<h3 id="option-3-production-setup-with-reverse-proxy">Option 3: Production Setup with Reverse Proxy</h3>
<p>For production environments, the recommended approach is to use a reverse proxy:</p>
<details>
    <summary>Nginx reverse proxy configuration</summary>

<div class="highlight"><pre><span></span><code><span class="c1"># /etc/nginx/sites-available/fastapi-app</span>

<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1"># Listen on port 80 and redirect to HTTPS</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">yourdomain.com</span><span class="w"> </span><span class="s">www.yourdomain.com</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Redirect all HTTP requests to HTTPS</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1"># Listen on port 443 for HTTPS connections</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">yourdomain.com</span><span class="w"> </span><span class="s">www.yourdomain.com</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># SSL certificate configuration</span>
<span class="w">    </span><span class="kn">ssl_certificate</span><span class="w"> </span><span class="s">/etc/letsencrypt/live/yourdomain.com/fullchain.pem</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_certificate_key</span><span class="w"> </span><span class="s">/etc/letsencrypt/live/yourdomain.com/privkey.pem</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Modern SSL configuration</span>
<span class="w">    </span><span class="kn">ssl_protocols</span><span class="w"> </span><span class="s">TLSv1.2</span><span class="w"> </span><span class="s">TLSv1.3</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_ciphers</span><span class="w"> </span><span class="s">ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># SSL session settings</span>
<span class="w">    </span><span class="kn">ssl_session_timeout</span><span class="w"> </span><span class="s">1d</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_cache</span><span class="w"> </span><span class="s">shared:SSL:10m</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_tickets</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># HSTS (optional, but recommended)</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Strict-Transport-Security</span><span class="w"> </span><span class="s">&quot;max-age=63072000&quot;</span><span class="w"> </span><span class="s">always</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># OCSP Stapling</span>
<span class="w">    </span><span class="kn">ssl_stapling</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_stapling_verify</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="w">    </span><span class="kn">resolver</span><span class="w"> </span><span class="mi">8</span><span class="s">.8.8.8</span><span class="w"> </span><span class="mi">8</span><span class="s">.8.4.4</span><span class="w"> </span><span class="s">valid=300s</span><span class="p">;</span>
<span class="w">    </span><span class="kn">resolver_timeout</span><span class="w"> </span><span class="s">5s</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Proxy settings</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://localhost:8000</span><span class="p">;</span><span class="w">  </span><span class="c1"># Your FastAPI app running on port 8000</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w"> </span><span class="nv">$scheme</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>

<h3 id="setting-up-https-in-production-recommended-steps">Setting Up HTTPS in Production: Recommended Steps</h3>
<ol>
<li>
<p><strong>Get a Real Certificate</strong>:</p>
<ul>
<li>Use Let's Encrypt for free TLS certificates:
    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>certbot
sudo<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--standalone<span class="w"> </span>-d<span class="w"> </span>yourdomain.com
</code></pre></div></li>
<li>This generates certificates in <code>/etc/letsencrypt/live/yourdomain.com/</code></li>
</ul>
</li>
<li>
<p><strong>Set Up Nginx as Reverse Proxy</strong>:</p>
<ul>
<li>Install Nginx: <code>sudo apt-get install nginx</code></li>
<li>Create a config file (see "Nginx reverse proxy configuration" above)</li>
<li>Enable the site: <code>sudo ln -s /etc/nginx/sites-available/fastapi-app /etc/nginx/sites-enabled/</code></li>
<li>Test and restart: <code>sudo nginx -t &amp;&amp; sudo systemctl restart nginx</code></li>
</ul>
</li>
<li>
<p><strong>Run FastAPI Without SSL</strong>:</p>
<ul>
<li>Let Nginx handle SSL/TLS</li>
<li>Run FastAPI internally: <code>uvicorn main:app --host 127.0.0.1 --port 8000</code></li>
</ul>
</li>
<li>
<p><strong>Set Up as a Service</strong> (using systemd):</p>
<p><details>
    <summary>FastAPI systemd service configuration</summary></p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># /etc/systemd/system/fastapi.service</span>

<span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">FastAPI application</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">yourusername</span>
<span class="na">Group</span><span class="o">=</span><span class="s">yourusername</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/path/to/your/app</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/path/to/your/venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">always</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</code></pre></div>
</details></p>
<p>Then enable and start the service:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>fastapi
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>fastapi
</code></pre></div></p>
</li>
</ol>
<h3 id="local-development-with-https">Local Development with HTTPS</h3>
<p>For local development with HTTPS:</p>
<ol>
<li>Generate self-signed certificates (see the script above)</li>
<li>Run with SSL options:
   <div class="highlight"><pre><span></span><code>uvicorn<span class="w"> </span>main:app<span class="w"> </span>--ssl-keyfile<span class="o">=</span>./key.pem<span class="w"> </span>--ssl-certfile<span class="o">=</span>./cert.pem
</code></pre></div></li>
<li>Accept the security warning in your browser (or add an exception)</li>
</ol>
<p>Remember that for WebAuthn development, you can use <code>localhost</code> without HTTPS, but any other domain requires HTTPS.</p>
<h3 id="best-practices-for-https-in-production">Best Practices for HTTPS in Production</h3>
<ol>
<li><strong>Use a Reverse Proxy</strong> (Nginx/Apache) to handle SSL termination</li>
<li><strong>Auto-renew certificates</strong> using Let's Encrypt's certbot</li>
<li><strong>Implement HSTS</strong> (HTTP Strict Transport Security)</li>
<li><strong>Configure strong ciphers</strong> for optimal security</li>
<li><strong>Use HTTP/2</strong> for better performance</li>
<li><strong>Test your SSL configuration</strong> with tools like SSL Labs</li>
</ol>
<h2 id="understanding-jwt-in-webauthn">Understanding JWT in WebAuthn</h2>
<p>JSON Web Token plays an important complementary role in WebAuthn implementations.</p>
<h3 id="what-is-jwt">What is JWT?</h3>
<p>JWT (JSON Web Token) is a compact, self-contained way to securely transmit information between parties as a JSON object. This information is digitally signed, so it can be verified and trusted. JWTs are commonly used for:</p>
<ol>
<li><strong>Authentication</strong>: After a user logs in</li>
<li><strong>Information Exchange</strong>: Securely transferring data between parties</li>
<li><strong>Authorization</strong>: Controlling what resources a user can access</li>
</ol>
<p>A JWT consists of three parts separated by dots:
- <strong>Header</strong>: Specifies the token type and signing algorithm
- <strong>Payload</strong>: Contains the claims (data)
- <strong>Signature</strong>: Ensures the token hasn't been altered</p>
<h3 id="jwts-role-in-webauthn">JWT's Role in WebAuthn</h3>
<p>In a WebAuthn implementation, JWT serves a different purpose than WebAuthn itself:</p>
<h4 id="webauthns-role">WebAuthn's Role:</h4>
<ul>
<li>Handles the initial <strong>authentication</strong> (proving who you are)</li>
<li>Uses cryptographic keys stored in hardware</li>
<li>Provides strong authentication without passwords</li>
<li>Tied to the specific origin (website)</li>
</ul>
<h4 id="jwts-role">JWT's Role:</h4>
<ul>
<li>Handles <strong>authorization</strong> (what you can access)</li>
<li>Maintains user session after authentication</li>
<li>Carries identity information across API calls</li>
<li>Enables stateless communication between client and server</li>
</ul>
<h3 id="typical-flow-in-a-webauthn-jwt-system">Typical Flow in a WebAuthn + JWT System</h3>
<ol>
<li>
<p><strong>User Authentication with WebAuthn</strong>:</p>
<ul>
<li>User proves identity using biometrics/security key</li>
<li>Server verifies the cryptographic proof</li>
</ul>
</li>
<li>
<p><strong>JWT Issuance</strong>:</p>
<ul>
<li>Upon successful WebAuthn authentication, server generates a JWT</li>
<li>JWT contains user identity and permissions</li>
<li>Server signs the JWT with its secret key</li>
</ul>
</li>
<li>
<p><strong>API Access with JWT</strong>:</p>
<ul>
<li>Client includes JWT in subsequent API requests</li>
<li>Server validates JWT signature and expiration</li>
<li>Server grants access based on claims in the JWT</li>
</ul>
</li>
<li>
<p><strong>Token Renewal</strong>:</p>
<ul>
<li>Client can request a new JWT before expiration</li>
<li>May require re-authentication with WebAuthn for security</li>
</ul>
</li>
</ol>
<h3 id="benefits-of-combining-webauthn-and-jwt">Benefits of Combining WebAuthn and JWT</h3>
<ul>
<li>
<p><strong>Separation of Concerns</strong>:</p>
<ul>
<li>WebAuthn handles secure authentication</li>
<li>JWT handles ongoing authorization</li>
</ul>
</li>
<li>
<p><strong>Improved UX</strong>:</p>
<ul>
<li>User only needs to perform WebAuthn authentication occasionally</li>
<li>JWT provides smooth access between authentications</li>
</ul>
</li>
<li>
<p><strong>Scalability</strong>:</p>
<ul>
<li>JWT enables stateless authentication for APIs</li>
<li>Reduces database lookups for session validation</li>
</ul>
</li>
<li>
<p><strong>Security Layers</strong>:</p>
<ul>
<li>WebAuthn provides phishing-resistant initial auth</li>
<li>Short-lived JWTs limit the impact of token theft</li>
</ul>
</li>
</ul>
<h3 id="implementation-considerations">Implementation Considerations</h3>
<ul>
<li><strong>Token Lifetime</strong>: Shorter lifetimes (15-60 minutes) improve security</li>
<li><strong>Token Storage</strong>: Store JWT securely (memory for SPA, HttpOnly cookies for web apps)</li>
<li><strong>Claims</strong>: Include only necessary data (user ID, roles, permissions)</li>
<li><strong>Refresh Strategy</strong>: Consider using refresh tokens for longer sessions</li>
<li><strong>Revocation</strong>: Implement token blacklisting for compromised tokens</li>
</ul>
<p>In essence, WebAuthn and JWT work together to create a complete authentication and authorization system  WebAuthn provides strong initial identity verification, while JWT provides the ongoing session management and API access authorization.</p>
<h2 id="maybe-use-google-authenticator-instead">Maybe use Google Authenticator instead?</h2>
<p>Google Authenticator provides weaker security, and the user experience is
more burdensome.</p>
<p>Google Authenticator is a Time-based One-Time Password (TOTP) solution
that works differently from WebAuthn:</p>
<h4 id="google-authenticator">Google Authenticator:</h4>
<ul>
<li><strong>How it works</strong>: Generates time-based codes that change every 30 seconds</li>
<li><strong>User experience</strong>: User manually enters a 6-digit code</li>
<li><strong>Setup</strong>: Requires scanning a QR code or entering a secret key</li>
<li><strong>Portability</strong>: Works across any device that has the app</li>
<li><strong>Authentication flow</strong>: Still requires username/password PLUS the code</li>
</ul>
<h4 id="webauthn">WebAuthn:</h4>
<ul>
<li><strong>How it works</strong>: Uses public-key cryptography with physical authenticators</li>
<li><strong>User experience</strong>: User interacts with biometrics or security key</li>
<li><strong>Setup</strong>: Uses device's built-in authenticator capabilities</li>
<li><strong>Portability</strong>: May require registering multiple devices</li>
<li><strong>Authentication flow</strong>: Can completely replace passwords</li>
</ul>
<h3 id="implementation-with-google-authenticator">Implementation with Google Authenticator</h3>
<p>Here's what you would need to implement Google Authenticator with API tokens.</p>
<h4 id="server-side_1">Server side</h4>
<details>
    <summary>Python code</summary>

<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Google Authenticator (TOTP) Implementation with FastAPI and JWT tokens</span>

<span class="sd">This implementation demonstrates how to use Google Authenticator with FastAPI</span>
<span class="sd">and issue API tokens upon successful authentication.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBearer</span><span class="p">,</span> <span class="n">HTTPAuthorizationCredentials</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.templating</span><span class="w"> </span><span class="kn">import</span> <span class="n">Jinja2Templates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyotp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qrcode</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;FastAPI Google Authenticator Example&quot;</span><span class="p">)</span>

<span class="c1"># This would be your database in a real application</span>
<span class="n">users_db</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">totp_secrets</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Token configuration</span>
<span class="n">JWT_SECRET</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">TOKEN_ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
<span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">token_blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="c1"># OAuth2 scheme for token authentication</span>
<span class="n">security</span> <span class="o">=</span> <span class="n">HTTPBearer</span><span class="p">()</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">Jinja2Templates</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">)</span>

<span class="c1"># Pydantic models</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserRegistration</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># In real app, you&#39;d hash this</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TOTPVerification</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">totp_code</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="n">datetime</span>

<span class="c1"># Token utilities (same as WebAuthn example)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new JWT token with expiration time&quot;&quot;&quot;</span>
    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">expires_delta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>

    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">TOKEN_ALGORITHM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">encoded_jwt</span><span class="p">,</span> <span class="n">expire</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify a JWT token and return the payload&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">token_blacklist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Token has been revoked&quot;</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">JWT_SECRET</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">TOKEN_ALGORITHM</span><span class="p">])</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid token&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">PyJWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid token or token expired&quot;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span><span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dependency to get the current user from a token&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">users_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="c1"># User registration</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserRegistration</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a new user and generate a TOTP secret&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>

    <span class="c1"># Check if user already exists</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User already exists&quot;</span><span class="p">)</span>

    <span class="c1"># Generate a unique user ID</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="c1"># Generate a TOTP secret</span>
    <span class="n">totp_secret</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">random_base32</span><span class="p">()</span>

    <span class="c1"># Create TOTP object</span>
    <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">totp_secret</span><span class="p">)</span>

    <span class="c1"># Store user (in a real app, you&#39;d hash the password)</span>
    <span class="n">users_db</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="p">}</span>

    <span class="c1"># Store TOTP secret</span>
    <span class="n">totp_secrets</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">totp_secret</span>

    <span class="c1"># Generate QR code for Google Authenticator</span>
    <span class="n">provisioning_uri</span> <span class="o">=</span> <span class="n">totp</span><span class="o">.</span><span class="n">provisioning_uri</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">issuer_name</span><span class="o">=</span><span class="s2">&quot;FastAPI TOTP Example&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create QR code image</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="n">qrcode</span><span class="o">.</span><span class="n">QRCode</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">error_correction</span><span class="o">=</span><span class="n">qrcode</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">ERROR_CORRECT_L</span><span class="p">,</span>
        <span class="n">box_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">border</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">qr</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">provisioning_uri</span><span class="p">)</span>
    <span class="n">qr</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">make_image</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">back_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

    <span class="c1"># Convert image to base64 for embedding in HTML</span>
    <span class="n">buffered</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffered</span><span class="p">)</span>
    <span class="n">img_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffered</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User registered successfully&quot;</span><span class="p">,</span>
        <span class="s2">&quot;totp_secret&quot;</span><span class="p">:</span> <span class="n">totp_secret</span><span class="p">,</span>  <span class="c1"># In a real app, don&#39;t return this directly</span>
        <span class="s2">&quot;qr_code&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">img_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;setup_instructions&quot;</span><span class="p">:</span> <span class="s2">&quot;Scan this QR code with Google Authenticator app&quot;</span>
    <span class="p">}</span>

<span class="c1"># Verify TOTP and get token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_totp</span><span class="p">(</span><span class="n">verification</span><span class="p">:</span> <span class="n">TOTPVerification</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify TOTP code and issue an access token&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">username</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">password</span>
    <span class="n">totp_code</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">totp_code</span>

    <span class="c1"># Check if user exists</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User does not exist&quot;</span><span class="p">)</span>

    <span class="c1"># Verify password (in a real app, you&#39;d verify hashed password)</span>
    <span class="k">if</span> <span class="n">users_db</span><span class="p">[</span><span class="n">username</span><span class="p">][</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">password</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid credentials&quot;</span><span class="p">)</span>

    <span class="c1"># Check if user has TOTP secret</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">totp_secrets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;TOTP not set up for user&quot;</span><span class="p">)</span>

    <span class="c1"># Verify TOTP code</span>
    <span class="n">totp</span> <span class="o">=</span> <span class="n">pyotp</span><span class="o">.</span><span class="n">TOTP</span><span class="p">(</span><span class="n">totp_secrets</span><span class="p">[</span><span class="n">username</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">totp</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">totp_code</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid TOTP code&quot;</span><span class="p">)</span>

    <span class="c1"># Generate access token</span>
    <span class="n">access_token</span><span class="p">,</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">},</span>
        <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentication successful&quot;</span><span class="p">,</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expire</span>
    <span class="p">}</span>

<span class="c1"># Token refresh endpoint</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token/refresh&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_token</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a fresh token with new expiration&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>

    <span class="n">access_token</span><span class="p">,</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">},</span>
        <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expire</span>
    <span class="p">}</span>

<span class="c1"># Token revocation endpoint</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token/revoke&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">revoke_token</span><span class="p">(</span><span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Revoke a token by adding it to the blacklist&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>

    <span class="c1"># Verify the token is valid</span>
    <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="c1"># Add to blacklist</span>
    <span class="n">token_blacklist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Token revoked successfully&quot;</span><span class="p">}</span>

<span class="c1"># Protected API endpoint example</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/protected-data&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_protected_data</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example of a protected API endpoint&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, this is protected data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;secret_value&quot;</span><span class="p">:</span> <span class="s2">&quot;This data is only accessible with a valid token&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1"># Simple HTML page for testing</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_root</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;totp_index.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>
</code></pre></div>

</details>

<h4 id="client-side_1">Client side</h4>
<details>
    <summary>HTML, JavaScript</summary>

<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- </span>
<span class="cm">  templates/totp_index.html</span>
<span class="cm">  This is a simple client-side implementation for Google Authenticator TOTP with FastAPI.</span>
<span class="cm">  Place this file in a &#39;templates&#39; directory in your FastAPI project.</span>
<span class="cm">--&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Google Authenticator Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">        </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">            </span><span class="k">max-width</span><span class="p">:</span><span class="w"> </span><span class="mi">800</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">container</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">            </span><span class="k">flex-wrap</span><span class="p">:</span><span class="w"> </span><span class="kc">wrap</span><span class="p">;</span>
<span class="w">            </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">space-between</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">panel</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">flex</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#ccc</span><span class="p">;</span>
<span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">button</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="w"> </span><span class="mi">16</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#4CAF50</span><span class="p">;</span>
<span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
<span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">button</span><span class="p">:</span><span class="nd">hover</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#45a049</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">input</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">box-sizing</span><span class="p">:</span><span class="w"> </span><span class="kc">border-box</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">qr-code</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">qr-code</span><span class="w"> </span><span class="nt">img</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">max-width</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">status</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">success</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#dff0d8</span><span class="p">;</span>
<span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#3c763d</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f2dede</span><span class="p">;</span>
<span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#a94442</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Google Authenticator Example<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Register<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;register-username&quot;</span><span class="p">&gt;</span>Username:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;register-username&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter username&quot;</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;register-password&quot;</span><span class="p">&gt;</span>Password:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;register-password&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter password&quot;</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;register-button&quot;</span><span class="p">&gt;</span>Register<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;register-status&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;status&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;qr-container&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;qr-code&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: none;&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Scan this QR code with Google Authenticator<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">img</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;qr-code&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">alt</span><span class="o">=</span><span class="s">&quot;QR Code&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Please save this QR code or secret key. You won&#39;t be able to see it again!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Secret key: <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;totp-secret&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;login-username&quot;</span><span class="p">&gt;</span>Username:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-username&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter username&quot;</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;login-password&quot;</span><span class="p">&gt;</span>Password:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-password&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter password&quot;</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;totp-code&quot;</span><span class="p">&gt;</span>Google Authenticator Code:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;totp-code&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;6-digit code&quot;</span> <span class="na">maxlength</span><span class="o">=</span><span class="s">&quot;6&quot;</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-button&quot;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-status&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;status&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>API Access<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Token Status: <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;token-info&quot;</span><span class="p">&gt;</span>Not logged in<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;fetch-data-button&quot;</span><span class="p">&gt;</span>Fetch Protected Data<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;logout-button&quot;</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Protected Data:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">pre</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;protected-data&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">        </span><span class="c1">// Token storage</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Check if token exists in localStorage on page load</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Try to restore token from localStorage</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;tokenExpiry&#39;</span><span class="p">));</span>

<span class="w">                </span><span class="c1">// Check if token is still valid</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;token-info&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                        </span><span class="sb">`Token valid until </span><span class="si">${</span><span class="nx">tokenExpiry</span><span class="p">.</span><span class="nx">toLocaleTimeString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">clearToken</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Store token</span>
<span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">storeToken</span><span class="p">(</span><span class="nx">tokenData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">access_token</span><span class="p">;</span>
<span class="w">            </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">expires_at</span><span class="p">);</span>

<span class="w">            </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">access_token</span><span class="p">);</span>
<span class="w">            </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;tokenExpiry&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">expires_at</span><span class="p">);</span>

<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;token-info&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                </span><span class="sb">`Token valid until </span><span class="si">${</span><span class="nx">tokenExpiry</span><span class="p">.</span><span class="nx">toLocaleTimeString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Clear token</span>
<span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">clearToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;tokenExpiry&#39;</span><span class="p">);</span>

<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;token-info&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Not logged in&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;protected-data&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Register new user</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;register-button&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;register-username&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;register-password&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">username</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;register-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Please enter username and password&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                        </span><span class="nx">username</span><span class="p">,</span>
<span class="w">                        </span><span class="nx">password</span>
<span class="w">                    </span><span class="p">}),</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">detail</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Registration failed&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// Display QR code</span>
<span class="w">                </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;qr-code&#39;</span><span class="p">).</span><span class="nx">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">qr_code</span><span class="p">;</span>
<span class="w">                </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;totp-secret&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">totp_secret</span><span class="p">;</span>
<span class="w">                </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;qr-container&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="p">;</span>

<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;register-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Registration successful! Scan the QR code with Google Authenticator app.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;register-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`Error: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Login with TOTP</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;login-button&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;login-username&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;login-password&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">totpCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;totp-code&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">username</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">password</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">totpCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Please enter all fields&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                        </span><span class="nx">username</span><span class="p">,</span>
<span class="w">                        </span><span class="nx">password</span><span class="p">,</span>
<span class="w">                        </span><span class="nx">totp_code</span><span class="o">:</span><span class="w"> </span><span class="nx">totpCode</span>
<span class="w">                    </span><span class="p">}),</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">detail</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Login failed&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// Store token</span>
<span class="w">                </span><span class="nx">storeToken</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Login successful!&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">updateStatus</span><span class="p">(</span><span class="s1">&#39;login-status&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`Error: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Fetch protected data</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;fetch-data-button&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">authToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Please login first&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/protected-data&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">authToken</span><span class="si">}</span><span class="sb">`</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">401</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">clearToken</span><span class="p">();</span>
<span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Token expired. Please login again.&#39;</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch data&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">                </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;protected-data&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Logout</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;logout-button&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">authToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Not logged in&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/token/revoke&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">authToken</span><span class="si">}</span><span class="sb">`</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to revoke token&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">clearToken</span><span class="p">();</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Logged out successfully&#39;</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Clear token anyway</span>
<span class="w">                </span><span class="nx">clearToken</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Helper function to update status</span>
<span class="w">        </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateStatus</span><span class="p">(</span><span class="nx">elementId</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">statusElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">elementId</span><span class="p">);</span>
<span class="w">            </span><span class="nx">statusElement</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">;</span>
<span class="w">            </span><span class="nx">statusElement</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;status &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">type</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</details>

<h3 id="setup-requirements-for-google-authenticator">Setup Requirements for Google Authenticator</h3>
<p>To implement this solution, you'll need to install these packages:</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span>uvicorn<span class="w"> </span>pyotp<span class="w"> </span>qrcode<span class="w"> </span>pillow<span class="w"> </span>python-jose<span class="o">[</span>cryptography<span class="o">]</span><span class="w"> </span>jinja2
</code></pre></div>
<h3 id="key-differences-from-webauthn">Key Differences from WebAuthn</h3>
<ol>
<li>
<p><strong>Authentication Flow</strong>:</p>
<ul>
<li>WebAuthn: Single-step biometric/security key verification</li>
<li>Google Auth: Multi-step process (username + password + TOTP code)</li>
</ul>
</li>
<li>
<p><strong>Security Model</strong>:</p>
<ul>
<li>WebAuthn: Based on public-key cryptography (more secure)</li>
<li>Google Auth: Based on shared secrets and time synchronization</li>
</ul>
</li>
<li>
<p><strong>User Experience</strong>:</p>
<ul>
<li>WebAuthn: Seamless, integrated with device/browser</li>
<li>Google Auth: Requires manual code entry from a separate app</li>
</ul>
</li>
<li>
<p><strong>Phishing Resistance</strong>:</p>
<ul>
<li>WebAuthn: High (cryptographically bound to origin)</li>
<li>Google Auth: Medium (TOTP codes can be phished)</li>
</ul>
</li>
</ol>
<h4 id="pros-of-google-authenticator">Pros of Google Authenticator</h4>
<ol>
<li><strong>Familiarity</strong>: Many users already have and understand Google Authenticator</li>
<li><strong>Device Independence</strong>: Works across all devices without special hardware</li>
<li><strong>Simpler Implementation</strong>: Less complex than WebAuthn</li>
<li><strong>Compatibility</strong>: Works with older browsers and systems</li>
</ol>
<h4 id="cons-of-google-authenticator">Cons of Google Authenticator</h4>
<ol>
<li><strong>User Friction</strong>: Requires users to switch to another app and type codes</li>
<li><strong>Shared Secret</strong>: The TOTP secret must be stored on both server and user device</li>
<li><strong>Still Password-Dependent</strong>: Doesn't eliminate password vulnerabilities</li>
<li><strong>Lower Security</strong>: More vulnerable to phishing attacks than WebAuthn</li>
</ol>
<h3 id="which-to-choose">Which to Choose?</h3>
<ul>
<li><strong>WebAuthn</strong>: Better for security-critical applications where you want to eliminate passwords</li>
<li><strong>Google Authenticator</strong>: Better for backward compatibility and when users may not have supported devices</li>
</ul>
<p>In both cases, the API token issuance after authentication works the same way - the main difference is just in how users prove their identity initially.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.indexes", "content.tabs.link", "content.code.annotate"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../javascripts/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>